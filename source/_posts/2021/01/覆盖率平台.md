---
title: 覆盖率平台
categories:
- 工作
- 方案
tags:
- 代码质量
- 覆盖率
date: 2021-01-04 11:07:00
---

 

# 一、背景
测试过程中存在很多的问题。

开发同学代码完成后，新功能是否有相关的单元测试？

测试同学在测试过程中，测试用例是否足够完善，是否完全覆盖功能点？

多次版本迭代后，是否存在废弃代码？

用例执行了，这部分代码逻辑是否真的执行到了？

代码修改了，需要重新测哪些功能？需要全量回归么？

这些问题都可以通过代码覆盖率平台来解决。

1、单元/自动化接口/功能测试后，统计覆盖率，查看未覆盖部分的代码，判断测试设计是否充分。
分析为什么存在没有覆盖到的代码，是否对需求理解存在偏差。

2、检测出程序中的废代码，可以逆向反推在代码设计中思维混乱点，提醒设计/开发人员理清代码逻辑关系，提升代码质量。

3、实时染色，显示代码覆盖情况，测试同学可以很清楚的看到，执行用例后，代码的执行情况。

4、建立代码与用例的关联，代码修改，可以推出需要重新执行哪些用例。

# 二、目标/期望

- 充分了解测试情况 
  测试过程中覆盖和未覆盖的地方,可能存在的风险
- 补充/完善用例
  避免测试漏测，尽可能发现测试死角，反推测试用例完善
- 提升代码质量
  协助开发搜寻历史废弃代码(依托于方法覆盖率，及行覆盖率染色，为废弃代码判断提供依据)
  提供代码拆分的指导意见(直观分析热区代码，为优化提供方向支撑)
  在项目流程中，形成质量卡点，强化质量意识
- 易于形成测试质量指标
  通过质量指标化，质量仪表可视化，促进测试质量的提升
- 精准测试回归，在项目快速迭代节奏下从容评估回归测试范围
  自动关联接口用例与接口代码的映射关系，在提交改动的时候，从海量回归case中快速提取测试case
  

将其分为3个阶段

![覆盖率平台阶段](覆盖率平台阶段.png)

第一期的内容包括
- PHP的全量覆盖率统计
- PHP的增量覆盖率统计
- 数据持久化存储及其展示
- 接入CICD流水线中

# 三、技术方案

[参考:基于 php-code-coverage 的增量代码覆盖率实现](https://testerhome.com/articles/20116)
[参考:代码覆盖率平台实现](https://testerhome.com/articles/23288)
[参考:代码实时染色系统](https://testerhome.com/topics/23915)

## 1. PHP的全量覆盖率统计
### 环境依赖
- xdebug: php插件，用于收集覆盖率信息
- git: 利用git diff获取增量代码信息
- php-code-coverage: phpunit下的一个库，用于从xdebug收集的覆盖率信息中生成覆盖率统计报告，支持xml、html等多种格式。

## 2. PHP的增量覆盖率统计

## 3. 数据持久化存储及其展示
每一次统计过后，存储相关数据。
可查询历史记录。
图表展示覆盖率变化趋势（比如使用折线图）。

## 4. 接入CICD流水线中
做好配置，代码提交后，可自动触发单元测试，接口测试

# 四、影响范围

# 五、涉及端

# 六、上线清单

# 七、线上观测